<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsip Kuliahku - Standalone</title>
    
    <!-- 1. Tailwind CSS (untuk styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Import Map (untuk mengatur sumber library React & Icons) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <!-- 3. Babel Standalone (untuk menerjemahkan JSX ke JavaScript biasa di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar agar lebih rapi */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <!-- Container Utama React -->
    <div id="root"></div>

    <!-- Script Utama Aplikasi -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Trash2, ExternalLink, Plus, BookOpen, Search, 
            FolderOpen, FileText, Edit2, Calendar, PieChart, 
            Tag, Bell, Save, X, Filter 
        } from 'lucide-react';
        
        // Import Firebase Modules dari CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            deleteDoc, 
            updateDoc, 
            doc, 
            onSnapshot, 
            serverTimestamp, 
            increment 
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- KONFIGURASI FIREBASE ---
        // Jika dijalankan di preview AI ini, gunakan config otomatis.
        // Jika dijalankan lokal (di laptopmu), GANTI isi firebaseConfig dengan config dari console firebase-mu.
        let firebaseConfig;
        let appId = 'default-app-id';
        
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            } else {
                throw new Error("No config found");
            }
        } catch (e) {
            // CONTOH CONFIG (Ganti ini jika dijalankan lokal di file index.html sendiri)
            // firebaseConfig = {
            //   apiKey: "API_KEY_KAMU",
            //   authDomain: "PROJECT_ID.firebaseapp.com",
            //   projectId: "PROJECT_ID",
            //   storageBucket: "PROJECT_ID.appspot.com",
            //   messagingSenderId: "SENDER_ID",
            //   appId: "APP_ID"
            // };
            console.warn("Harap masukkan konfigurasi Firebase Anda di bagian script.");
        }

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const COLLECTION_NAME = 'study_archives_v2';
        const SEMESTERS = [1, 2, 3, 4, 5, 6, 7, 8, 'Pendek'];
        const ACADEMIC_YEARS = ['2022/2023', '2023/2024', '2024/2025', '2025/2026'];
        const MONTHS = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        function App() {
            // --- State Utama ---
            const [archives, setArchives] = useState([]);
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('archives'); 
            const [showForm, setShowForm] = useState(false);

            // --- State Form ---
            const [formData, setFormData] = useState({
                id: null,
                title: '',
                link: '',
                category: 'Mata Kuliah Umum',
                semester: '1',
                academicYear: '2024/2025',
                month: MONTHS[new Date().getMonth()],
                description: '',
                tags: ''
            });

            const [searchTerm, setSearchTerm] = useState('');
            const [filterSemester, setFilterSemester] = useState('All');

            // --- Auth & Data Fetching ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        // Cek token khusus environment ini
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                // Gunakan path sesuai aturan environment ini
                const archivesRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                
                const unsubscribe = onSnapshot(archivesRef, (snapshot) => {
                    const items = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    items.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setArchives(items);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            // --- Handlers ---
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const resetForm = () => {
                setFormData({
                    id: null,
                    title: '',
                    link: '',
                    category: 'Mata Kuliah Umum',
                    semester: '1',
                    academicYear: '2024/2025',
                    month: MONTHS[new Date().getMonth()],
                    description: '',
                    tags: ''
                });
                setShowForm(false);
            };

            const handleEditClick = (item) => {
                setFormData({
                    id: item.id,
                    title: item.title,
                    link: item.url,
                    category: item.category,
                    semester: item.semester,
                    academicYear: item.academicYear,
                    month: item.month || MONTHS[0],
                    description: item.description || '',
                    tags: item.tags ? item.tags.join(', ') : ''
                });
                setShowForm(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) return;
                try {
                    let formattedLink = formData.link;
                    if (!/^https?:\/\//i.test(formData.link)) formattedLink = 'https://' + formData.link;
                    const tagArray = formData.tags.split(',').map(t => t.trim()).filter(t => t);
                    const payload = {
                        title: formData.title,
                        url: formattedLink,
                        category: formData.category,
                        semester: formData.semester,
                        academicYear: formData.academicYear,
                        month: formData.month,
                        description: formData.description,
                        tags: tagArray,
                        updatedAt: serverTimestamp()
                    };
                    const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);

                    if (formData.id) {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, formData.id);
                        await updateDoc(docRef, payload);
                    } else {
                        await addDoc(collectionRef, {
                            ...payload,
                            createdAt: serverTimestamp(),
                            clickCount: 0,
                            createdBy: user.uid
                        });
                    }
                    resetForm();
                } catch (error) {
                    console.error("Error saving:", error);
                    alert("Gagal menyimpan data. Cek console log.");
                }
            };

            const handleDelete = async (id) => {
                if (window.confirm('Yakin hapus arsip ini?')) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, id));
                    } catch (error) { console.error(error); }
                }
            };

            const handleLinkClick = async (item) => {
                window.open(item.url, '_blank');
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, item.id);
                    await updateDoc(docRef, { clickCount: increment(1) });
                } catch (e) { console.log(e); }
            };

            // --- Filtering ---
            const processedArchives = useMemo(() => {
                let result = archives;
                if (searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    result = result.filter(item => 
                        item.title.toLowerCase().includes(lower) ||
                        item.category.toLowerCase().includes(lower) ||
                        (item.tags && item.tags.some(t => t.toLowerCase().includes(lower)))
                    );
                }
                if (filterSemester !== 'All') {
                    result = result.filter(item => String(item.semester) === String(filterSemester));
                }
                const grouped = {};
                result.forEach(item => {
                    const key = `Semester ${item.semester}`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(item);
                });
                return Object.keys(grouped).sort().reduce((obj, key) => {
                    obj[key] = grouped[key];
                    return obj;
                }, {});
            }, [archives, searchTerm, filterSemester]);

            const stats = useMemo(() => {
                const totalDocs = archives.length;
                const totalClicks = archives.reduce((acc, curr) => acc + (curr.clickCount || 0), 0);
                const byCategory = {};
                archives.forEach(a => { byCategory[a.category] = (byCategory[a.category] || 0) + 1; });
                return { totalDocs, totalClicks, byCategory };
            }, [archives]);

            // --- Komponen UI ---
            const SidebarItem = ({ icon: Icon, label, id }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors ${
                        activeTab === id 
                        ? 'bg-indigo-50 text-indigo-700' 
                        : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'
                    }`}
                >
                    <Icon size={18} />
                    {label}
                </button>
            );

            // --- Render UI Utama ---
            return (
                <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row font-sans text-slate-800">
                    
                    {/* Sidebar */}
                    <aside className="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 fixed h-full z-20">
                        <div className="p-6 border-b border-slate-100">
                            <div className="flex items-center gap-2 text-indigo-600 font-bold text-xl">
                                <BookOpen size={24} />
                                <span>MyArsip</span>
                            </div>
                            <p className="text-xs text-slate-400 mt-1">Standalone HTML Version</p>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            <SidebarItem icon={FolderOpen} label="Arsip Materi" id="archives" />
                            <SidebarItem icon={PieChart} label="Dashboard Statistik" id="stats" />
                            <SidebarItem icon={Calendar} label="Kalender Akademik" id="calendar" />
                        </nav>
                        <div className="p-4 border-t border-slate-100">
                           <div className="flex items-center gap-3 px-2">
                             <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs">M</div>
                             <div className="text-xs">
                               <p className="font-medium text-slate-700">Mahasiswa</p>
                               <p className="text-slate-400">Offline/Lokal</p>
                             </div>
                           </div>
                        </div>
                    </aside>

                    {/* Mobile Header */}
                    <div className="md:hidden fixed top-0 w-full bg-white border-b border-slate-200 z-30 px-4 py-3 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-2 text-indigo-600 font-bold">
                            <BookOpen size={20} />
                            <span>MyArsip</span>
                        </div>
                        <button onClick={() => setShowForm(!showForm)} className="bg-indigo-600 text-white p-2 rounded-full shadow-lg">
                            <Plus size={18} />
                        </button>
                    </div>

                    {/* Konten Utama */}
                    <main className="flex-1 md:ml-64 p-4 md:p-8 mt-16 md:mt-0 pb-24 md:pb-8">
                        {activeTab === 'archives' && (
                            <div className="max-w-4xl mx-auto fade-in">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                                    <div>
                                        <h1 className="text-2xl font-bold text-slate-900">Arsip Materi</h1>
                                        <p className="text-slate-500 text-sm">Kelola semua link Google Drive kuliahmu.</p>
                                    </div>
                                    <button 
                                        onClick={() => setShowForm(true)}
                                        className="hidden md:flex bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium items-center gap-2 shadow-sm transition-all"
                                    >
                                        <Plus size={16} /> Tambah Materi
                                    </button>
                                </div>

                                <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-col md:flex-row gap-3">
                                   <div className="relative flex-1">
                                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                    <input 
                                      type="text" 
                                      placeholder="Cari judul..." 
                                      className="w-full pl-9 pr-4 py-2 text-sm rounded-lg bg-slate-50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-100"
                                      value={searchTerm}
                                      onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                   </div>
                                   <div className="flex items-center gap-2">
                                     <Filter size={16} className="text-slate-400" />
                                     <select 
                                        value={filterSemester}
                                        onChange={(e) => setFilterSemester(e.target.value)}
                                        className="text-sm bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-100"
                                     >
                                       <option value="All">Semua Semester</option>
                                       {SEMESTERS.map(s => <option key={s} value={s}>Semester {s}</option>)}
                                     </select>
                                   </div>
                                </div>

                                {/* Form */}
                                {showForm && (
                                    <div className="bg-white rounded-xl border border-indigo-100 shadow-lg p-6 mb-8 relative fade-in">
                                        <button onClick={resetForm} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X size={20} /></button>
                                        <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                            {formData.id ? 'Edit Arsip' : 'Tambah Arsip Baru'}
                                        </h2>
                                        <form onSubmit={handleSubmit} className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1">Judul</label><input required name="title" value={formData.title} onChange={handleInputChange} className="w-full px-4 py-2 border rounded-lg" /></div>
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1">Kategori</label><input required name="category" value={formData.category} onChange={handleInputChange} className="w-full px-4 py-2 border rounded-lg" /></div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1">Semester</label><select name="semester" value={formData.semester} onChange={handleInputChange} className="w-full px-4 py-2 border rounded-lg">{SEMESTERS.map(s=><option key={s} value={s}>{s}</option>)}</select></div>
                                                <div><label className="block text-xs font-bold text-slate-500 mb-1">Tahun</label><select name="academicYear" value={formData.academicYear} onChange={handleInputChange} className="w-full px-4 py-2 border rounded-lg">{ACADEMIC_YEARS.map(y=><option key={y} value={y}>{y}</option>)}</select></div>
                                            </div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Link Drive</label><input required name="link" value={formData.link} onChange={handleInputChange} className="w-full px-4 py-2 border rounded-lg" placeholder="https://..." /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Tags</label><input name="tags" value={formData.tags} onChange={handleInputChange} className="w-full px-4 py-2 border rounded-lg" placeholder="tugas, uas..." /></div>
                                            <div className="flex gap-2 pt-2">
                                                <button type="button" onClick={resetForm} className="flex-1 py-2 border rounded-lg text-slate-600">Batal</button>
                                                <button type="submit" className="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Simpan</button>
                                            </div>
                                        </form>
                                    </div>
                                )}

                                {/* List */}
                                {loading ? <div className="text-center py-10">Memuat data...</div> : 
                                 Object.keys(processedArchives).length === 0 ? <div className="text-center py-10 text-slate-500">Belum ada data</div> :
                                 Object.entries(processedArchives).map(([semester, items]) => (
                                    <div key={semester} className="mb-6">
                                        <h3 className="font-bold text-slate-800 mb-3 bg-white inline-block px-3 py-1 rounded border shadow-sm">{semester}</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {items.map(item => (
                                                <div key={item.id} className="bg-white p-4 rounded-xl border hover:border-indigo-300 shadow-sm transition-all group relative">
                                                    <div className="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={() => handleEditClick(item)} className="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-indigo-600"><Edit2 size={14}/></button>
                                                        <button onClick={() => handleDelete(item.id)} className="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-red-600"><Trash2 size={14}/></button>
                                                    </div>
                                                    <span className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">{item.category}</span>
                                                    <h4 className="font-bold text-slate-800 mt-2">{item.title}</h4>
                                                    <div className="text-xs text-slate-500 mt-1 mb-3">{item.academicYear} â€¢ {item.clickCount||0}x klik</div>
                                                    <button onClick={() => handleLinkClick(item)} className="w-full bg-slate-900 text-white py-2 rounded-lg text-sm flex items-center justify-center gap-2 hover:bg-indigo-600 transition-colors">Buka Materi <ExternalLink size={14}/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="max-w-4xl mx-auto fade-in">
                                <h1 className="text-2xl font-bold mb-6">Statistik</h1>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="bg-white p-4 rounded-xl border text-center">
                                        <div className="text-2xl font-bold text-indigo-600">{stats.totalDocs}</div>
                                        <div className="text-xs text-slate-500">Total File</div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl border text-center">
                                        <div className="text-2xl font-bold text-green-600">{stats.totalClicks}</div>
                                        <div className="text-xs text-slate-500">Total Dibuka</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                             <div className="max-w-4xl mx-auto text-center py-20 bg-white border rounded-xl">
                                <Calendar className="mx-auto text-indigo-200 mb-4 w-12 h-12" />
                                <h3 className="font-bold text-slate-700">Fitur Kalender</h3>
                                <p className="text-slate-500 text-sm">Segera hadir di versi standalone v2.0</p>
                             </div>
                        )}
                    </main>

                    {/* Mobile Nav */}
                    <nav className="md:hidden fixed bottom-0 w-full bg-white border-t p-2 flex justify-around z-30">
                        <button onClick={() => setActiveTab('archives')} className={`flex flex-col items-center p-2 text-xs ${activeTab==='archives'?'text-indigo-600 font-bold':'text-slate-400'}`}><FolderOpen size={20}/>Arsip</button>
                        <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center p-2 text-xs ${activeTab==='stats'?'text-indigo-600 font-bold':'text-slate-400'}`}><PieChart size={20}/>Stats</button>
                        <button onClick={() => setActiveTab('calendar')} className={`flex flex-col items-center p-2 text-xs ${activeTab==='calendar'?'text-indigo-600 font-bold':'text-slate-400'}`}><Calendar size={20}/>Jadwal</button>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
